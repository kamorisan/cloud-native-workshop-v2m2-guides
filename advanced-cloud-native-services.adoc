= Advanced Cloud-Native Services
:experimental:

*Cloud Native Workshop - Module 1* を終了した場合、JBoss EAP と OpenShift を使用して既存のアプリケーションをクラウドに移行する方法を学び、マイクロサービスを使用して既存のアプリケーションをモダナイズするための OpenShift の力を垣間見ることができました。 +
Module 1 を学習しなかった場合、または学習を開始したが終了しなかった場合は、以下のスクリプトを実行して追いつくことができます。

このラボでは、開発者としてOpenShift Container Platformを使用してアプリケーションを構築し、デプロイする方法をより深く掘り下げていきます。開発者に関連するOpenShiftのコア機能に焦点を当て、開発者のための典型的なワークフロー（開発、ビルド、テスト、デプロイ、リピート）を学びます。

=== ラボの準備

[WARNING]
====
*Optimizing Existing Applications* モジュールをすでに完了している場合は、このモジュールのコードをインポートする必要があります。
Import Projects セクションにスキップしてください。
====

https://www.eclipse.org/che/[Eclipse Che^] をベースにしたオンライン IDE である Red Hat CodeReady Workspaces を使用します。 *ファイルへの変更は数秒ごとに自動保存される* ので、明示的に変更を保存する必要はありません。

開始するには、 {{ ECLIPSE_CHE_URL }}[CodeReady Workspaces インスタンスにアクセス^] し、 割り当てられたユーザー名とパスワードを使用してログインします。 (例: `{{ USER_ID }}/{{ CHE_USER_PASSWORD }}`)

image::che-login.png[cdw, 700]

ログインすると、個人のダッシュボードが表示されます。以下のように、左側にあるあらかじめ作成されたワークスペースの名前をクリックします（割り当てられた番号によって名前が異なります）。また、中央のワークスペースの名前をクリックして、画面右上のOpenと書かれた緑色の {{ USER_ID }}-namespace をクリックします。

1～2分後、ワークスペースに入れられます。

image::che-workspace.png[cdw, 900]

このIDEは、Eclipse Cheをベースにしています。 +
（Eclipse Che は、MicroSoft VS Code editorをベースにしています）。

プロジェクトエクスプローラ、検索、バージョン管理(Gitなど)、デバッグ、その他のプラグインの間を移動するためのアイコンが左に表示されています。このワークショップではこれらを使います。自由にクリックして何ができるか見てみてください。

image::crw-icons.png[cdw, 400]

[NOTE]
====
ブラウザの表示がおかしくなった場合には、ブラウザタブを再読み込みして表示を更新してください。
====

CodeReady Workspaces の多くの機能は、コマンドからアクセスできます。いくつかのコマンドは、ホームページにリンクが貼られています（例：New File...、Git Clone...など）。

メニューに表示されていないコマンドを実行する必要がある場合は、 kbd:[F1] を押すか、 kbd:[Control+SHIFT+P]を押してコマンドウィンドウを開くことができます。 +
 （Mac OS Xでは kbd:[Command+SHIFT+P] ）

==== Import Projects

Let's import the project source code for this lab. Click on **Git Clone..** (or type kbd:[F1], enter 'git' and click on the auto-completed _Git Clone.._ )
このラボのプロジェクトのソースコードをインポートしてみましょう。 **Git Clone..** をクリックします。(または kbd:[F1] と入力して 'git' と入力し、自動で作成された Git クローンをクリックします。)

image::che-workspace-gitclone.png[cdw, 900]

リポジトリの URL に次の値を使用して、プロンプトに沿ってステップを実行します。FireFoxを使用している場合、最後に余分なスペースを貼り付けてしまう可能性がありますので、貼り付けた後にバックスペースを押してください。

[source,none,role="copypaste"]
----
https://github.com/RedHat-Middleware-Workshops/cloud-native-workshop-v2m2-labs.git
----

image::crw-clone-repo.png[crw,900]

プロジェクトはワークスペースにインポートされ、プロジェクト エクスプローラに表示されます。

image::crw-clone-explorer.png[crw,900]

==== IMPORTANT: 適切な Git branch を check out

プロジェクトファイルの正しいバージョンを使用していることを確認するには、CodeReadyターミナルでこのコマンドを実行してください。

[source,sh,role="copypaste"]
----
cd $CHE_PROJECTS_ROOT/cloud-native-workshop-v2m2-labs && git checkout ocp-4.5
----

[NOTE]
====
CodeReady ワークスペースのターミナルウィンドウ。Developer ワークスペースで実行しているコンテナのいずれかのターミナルウィンドウを開くことができます。これらのラボの残りの部分については、ターミナルでコマンドを実行する必要がある場合はいつでも、右側の **>_ New Terminal** コマンドを使用することができます。
====

image::codeready-workspace-terminal.png[codeready-workspace-terminal, 700]

=== Remove other projects

今日、他のモジュール( `cloud-native-workshop-v2m1-lab` など)を完了した場合は、エクスプローラーでプロジェクト名を右クリックして削除を選択し、警告を受け入れてワークスペースから削除してください。このラボのためにインポートした新しいプロジェクトを削除しないように注意してください。

image::remove-workspace.png[remove, 700]

=== Login to OpenShift

Eclipse Che ワークスペースは Kubernetes クラスタ上で実行されていますが、デフォルトの制限付きサービスアカウントで実行されているため、ほとんどのリソースタイプを作成することができません。他のモジュールを完了している場合は、もう一度ログインしてみましょう: *Login to OpenShift* をクリックして、与えられた資格情報を入力します。

* Username: `{{ USER_ID }}`
* Password: `{{ OPENSHIFT_USER_PASSWORD }}`

image::cmd-login.png[login,700]

このようなものが表示されるはずです（プロジェクト名が異なる場合があります）。

[source,none]
----
Login successful.

You have access to the following projects and can switch between them with 'oc project <projectname>':

  * {{ USER_ID }}-bookinfo
    {{ USER_ID }}-catalog
    {{ USER_ID }}-cloudnative-pipeline
    {{ USER_ID }}-cloudnativeapps
    {{ USER_ID }}-inventory
    {{ USER_ID }}-istio-system

Using project "{{ USER_ID }}-bookinfo".
Welcome! See 'oc help' to get started.
----

[NOTE]
====
 *Login to OpenShift* でログインした後は、通常のターミナルとしては使えなくなります。ターミナルのウィンドウを閉じることができます。後からさらに端末を開いてもログインしたままになります
====

==== 今日の最初のモジュールの場合はこれを行い、そうでない場合は Verifying the Dev Environment に進みます。

これらのコマンドは、module 1 からのすべてのステップをリセットして再生し、終了するまでに4～5分かかるはずです。

[WARNING]
====
*Optimizing Existing Applications lab を完了し、 `catalog` と `inventory` と CoolStore `monolith` projects を作成している場合は、これらを実行する必要はありません!*
====

[source, sh, role="copypaste"]
----
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-inventory.sh {{ USER_ID }} && \
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-catalog.sh {{ USER_ID }} && \
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-coolstore.sh {{ USER_ID }}
----

[WARNING]
====
OpenShiftではネットワークレイテンシのために新規ビルドイメージの作成に時間がかかることがあります。
もし、 *Error from server (NotFound): services "catalog-springboot" not found* となり catalog-service のデプロイに失敗した場合は、以下のコマンドを使って、もう一度試してみてください。
====

[source, sh, role="copypaste"]
----
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-inventory.sh {{ USER_ID }} && \
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-catalog.sh {{ USER_ID }} 3m && \
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-coolstore.sh {{ USER_ID }}
----

コマンドが完了するのを待ちます。

=== Verifying the Dev Environment

In the previous module, you created a new OpenShift project called *{{ USER_ID }}-coolstore-dev* which represents your developer personal
project in which you deployed the CoolStore monolith.

==== Verify Application

Let’s take a moment and review the OpenShift resources that are created for the Monolith:

* Build Config: *coolstore* build config is the configuration for building the Monolith image from the source code or WAR file.
* Image Stream: *coolstore* image stream is the virtual view of all coolstore container images built and pushed to the OpenShift integrated registry.
* Deployment Config: *coolstore* deployment config deploys and redeploys the Coolstore container image whenever a new coolstore container image becomes available. Similarly, the *coolstore-postgresql* does the same for the database.
* Service: *coolstore* and *coolstore-postgresql* service is an internal load balancer which identifies a set of pods (containers) in order to proxy the connections it receives to them. Anything that depends on the service can to refer to it at a consistent address (service name or IP).
* Route: *www* route registers the service on the built-in external load-balancer and assigns a public DNS name to it so that it can be reached from outside OpenShift cluster.

[NOTE]
====
When referring to Kubernetes or OpenShift object types in `oc` commands, you can use short synonyms for long words, like *bc* instead of *buildconfig*, *is* for *imagestream*, *dc* for *deploymentconfig*, *svc* for *service*, etc.

Don’t worry about reading and understanding the output of oc describe. Just make sure the command doesn’t report errors!
====

Run these commands to inspect the elements via CodeReady Workspaces Terminal window:

[source,sh,role="copypaste"]
----
oc project {{ USER_ID }}-coolstore-dev && \
oc get bc coolstore && \
oc get is coolstore && \
oc get dc coolstore && \
oc get svc coolstore && \
oc describe route www
----

You should get a valid value for each, and no errors!

Visit the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-coolstore-dev[Topology View^] to see the coolstore app (and its database). The *Topology* view in the _Developer_ perspective of the OpenShift web console provides a visual representation of all the applications within a project, their build status, and the components and services associated with them. You'll visit this often:

image::coolstore-dev-topology.png[crw,700]

Verify that you can access the monolith by clicking on the route link (the arrow) to access the running monolith:

image::route_link.png[route_link]

The coolstore web interface should look like:

image::coolstore_web.png[route_link, 600]


=== Verify Database

You can log into the running Postgres container using the following via CodeReady Workspaces Terminal window:

[source,sh,role="copypaste"]
----
oc rsh dc/coolstore-postgresql
----

Once logged in, use the following command to execute an SQL statement to show some content from the database and then exit:

[source,sh,role="copypaste"]
----
psql -U $POSTGRESQL_USER $POSTGRESQL_DATABASE -c 'select name,price from PRODUCT_CATALOG;' | cat; exit
----

You should see the following:

----
          name          | price
------------------------+-------
 Red Fedora             | 34.99
 Forge Laptop Sticker   |   8.5
 Solid Performance Polo |  17.8
 Ogio Caliber Polo      | 28.75
 16 oz. Vortex Tumbler  |     6
 Pebble Smart Watch     |    24
 Oculus Rift            |   106
 Lytro Camera           |  44.3
 Atari 2600 Joystick    |   240
(9 rows)
----

This shows the content of the monolith's database.

With our running project on OpenShift, in the next step we’ll explore how you as a developer can work with the running app to make changes and debug the application!
